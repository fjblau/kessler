# Multi-Source Data Architecture with Envelope Pattern

Complete guide to the Kessler satellite tracking system's multi-source data management using MongoDB and the envelope pattern.

## Architecture Overview

The system uses an **envelope pattern** to manage satellite data from multiple sources:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         MongoDB Document (Envelope)     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ identifier: "2025-206B"                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚úÖ CANONICAL (Merged/Authoritative)     ‚îÇ
‚îÇ    ‚îú‚îÄ name (from UNOOSA)                ‚îÇ
‚îÇ    ‚îú‚îÄ country_of_origin (from UNOOSA)   ‚îÇ
‚îÇ    ‚îú‚îÄ registration_number (from UNOOSA) ‚îÇ
‚îÇ    ‚îú‚îÄ orbit: {...} (from CelesTrak)     ‚îÇ
‚îÇ    ‚îî‚îÄ tle: {...} (from CelesTrak)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìÅ SOURCES (Raw Data from Each Source)  ‚îÇ
‚îÇ    ‚îú‚îÄ unoosa: {...}                     ‚îÇ
‚îÇ    ‚îú‚îÄ celestrak: {...}                  ‚îÇ
‚îÇ    ‚îî‚îÄ spacetrack: {...} (future)        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìä METADATA (Tracking Info)             ‚îÇ
‚îÇ    ‚îú‚îÄ created_at                        ‚îÇ
‚îÇ    ‚îú‚îÄ last_updated_at                   ‚îÇ
‚îÇ    ‚îú‚îÄ sources_available: [...]          ‚îÇ
‚îÇ    ‚îî‚îÄ source_priority: [...]            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Key Principles

### 1. Single Source of Truth (Per Field)

Each field in `canonical` comes from the **highest-priority source** that has it:

```
Priority: UNOOSA > CelesTrak > Space-Track

canonical.name = unoosa.name  (if available)
                OR celestrak.name (if unoosa doesn't have it)
                OR spacetrack.name (if neither has it)
```

### 2. No Data Loss

All source data is preserved in the `sources` section:

```json
{
  "canonical": {
    "name": "GLONASS",      // from UNOOSA (higher priority)
    "tle_line1": "1 25544U..."  // from CelesTrak
  },
  "sources": {
    "unoosa": { "name": "GLONASS", ...},
    "celestrak": { "tle_line1": "1 25544U...", ...}
  }
}
```

### 3. Automatic Merging

The canonical section is **automatically updated** when new sources are added. Call `create_satellite_document()` with a new source, and canonical is regenerated by `update_canonical()`.

### 4. Transparent Sourcing

The `metadata.sources_available` field shows which sources contributed to each document:

```json
{
  "metadata": {
    "sources_available": ["unoosa", "celestrak"],
    "source_priority": ["unoosa", "celestrak", "spacetrack"]
  }
}
```

## Workflow: Adding New Sources

### Step 1: Import UNOOSA Data

```bash
python3 import_to_mongodb.py --clear
```

**Result**: 5,197 documents with UNOOSA registry data

```json
{
  "identifier": "2025-206B",
  "canonical": {
    "name": "(GLONASS)",
    "country_of_origin": "Russian Federation",
    "date_of_launch": "2025-09-13",
    "status": "in orbit",
    ...
  },
  "sources": {
    "unoosa": { ... }
  },
  "metadata": {
    "sources_available": ["unoosa"]
  }
}
```

### Step 2: Add CelesTrak TLE Data

```bash
python3 import_celestrak_tle_sample.py --test-only
```

**Result**: Documents now have TLE data from CelesTrak merged in

```json
{
  "identifier": "2025-206B",
  "canonical": {
    "name": "(GLONASS)",  // Still from UNOOSA
    "country_of_origin": "Russian Federation",  // Still from UNOOSA
    "orbit": {
      "apogee_km": 406.15,  // ‚ú® NEW from CelesTrak
      "perigee_km": 402.53,
      "inclination_degrees": 51.64,
      "period_minutes": 92.65
    },
    "tle": {
      "line1": "1 25544U...",  // ‚ú® NEW from CelesTrak
      "line2": "2 25544..."
    }
  },
  "sources": {
    "unoosa": { ... },
    "celestrak": { ... }  // ‚ú® NEW
  },
  "metadata": {
    "sources_available": ["unoosa", "celestrak"]  // ‚ú® UPDATED
  }
}
```

### Step 3: Add Future Sources (Space-Track, etc.)

```python
from db import create_satellite_document

# Add Space-Track data
create_satellite_document("2025-206B", "spacetrack", {
    "name": "GLONASS-K1",
    "satellite_catalog_number": "58023",
    ...
})

# Canonical automatically regenerates with priority: UNOOSA > CelesTrak > Space-Track
```

## Benefits

### 1. **Flexibility**
- Add new sources without changing existing data
- No schema migrations needed
- Each source can have different fields

### 2. **Data Quality**
- Keep best data from each source
- UNOOSA for registration info
- CelesTrak for precise orbital elements
- Space-Track for tracking/TLE updates

### 3. **Audit Trail**
- See exactly which source provided each piece of data
- Historical tracking via `updated_at` timestamps
- Resolve discrepancies by checking sources

### 4. **No Conflicts**
- Source priority rules eliminate manual decision-making
- Consistent, predictable behavior
- Easy to adjust priority if needed

### 5. **Performance**
- Single document per satellite (fast queries)
- Indexes on identifiers (fast lookups)
- Minimal data duplication

## Implementation Details

### Database Layer (db.py)

**Key functions**:

```python
# Create or update a satellite document
create_satellite_document(identifier, source, data)

# Update canonical from source nodes (automatic)
update_canonical(document)

# Find satellites
find_satellite(international_designator=...)
search_satellites(query=..., country=..., status=...)

# Aggregate data
get_all_countries()
get_all_statuses()
count_satellites()
```

### Import Scripts

**Import UNOOSA**:
```bash
import_to_mongodb.py
```
- Reads CSV file
- Extracts fields
- Creates documents with "unoosa" source

**Import CelesTrak**:
```bash
import_celestrak_tle.py              # Full network
import_celestrak_tle_sample.py       # With fallback
```
- Fetches TLE files
- Extracts orbital parameters
- Updates existing documents or creates new ones
- Canonical automatically recalculated

### API Layer (api.py)

**v2 endpoints** (MongoDB-aware):

```
GET /v2/health                  # Check MongoDB status
GET /v2/search                  # Search with filters
GET /v2/satellite/{id}          # Get full document with all sources
GET /v2/countries               # List all countries
GET /v2/statuses                # List all statuses
GET /v2/stats                   # Statistics
```

All endpoints:
- Use MongoDB when available
- Fall back to CSV if MongoDB is down
- Return `"source": "mongodb"` or `"source": "csv_fallback"`

## Data Flow Diagram

```
UNOOSA CSV
    ‚Üì
    ‚îú‚îÄ‚Üí import_to_mongodb.py
    ‚Üì
MongoDB Collection (5,197 docs)
    ‚Üì
    ‚îú‚îÄ‚Üí canonical: {registry info}
    ‚îú‚îÄ‚Üí sources.unoosa: {registry info}
    ‚îî‚îÄ‚Üí metadata: {tracking}

                    ‚Üì‚Üì‚Üì

CelesTrak TLE Files
    ‚Üì
    ‚îú‚îÄ‚Üí import_celestrak_tle.py
    ‚Üì
MongoDB Documents (updated)
    ‚Üì
    ‚îú‚îÄ‚Üí canonical: {registry + TLE}  ‚Üê Automatically merged!
    ‚îú‚îÄ‚Üí sources.unoosa: {registry}
    ‚îú‚îÄ‚Üí sources.celestrak: {TLE}
    ‚îî‚îÄ‚Üí metadata: {tracking + celestrak}

                    ‚Üì‚Üì‚Üì

Space-Track Data (future)
    ‚Üì
    ‚îú‚îÄ‚Üí import_spacetrack.py
    ‚Üì
MongoDB Documents (final)
    ‚Üì
    ‚îú‚îÄ‚Üí canonical: {best from all sources}  ‚Üê Final merge!
    ‚îú‚îÄ‚Üí sources.unoosa: {registry}
    ‚îú‚îÄ‚Üí sources.celestrak: {TLE}
    ‚îú‚îÄ‚Üí sources.spacetrack: {tracking}
    ‚îî‚îÄ‚Üí metadata: {all sources}

                    ‚Üì‚Üì‚Üì

API (/v2/*)
    ‚Üì
React Frontend / External Clients
```

## Practical Example

### Start with UNOOSA

```bash
python3 import_to_mongodb.py --clear
```

Query result:
```json
{
  "identifier": "2025-206B",
  "canonical": {
    "name": "(GLONASS)",
    "country_of_origin": "Russian Federation",
    "registration_number": "3832-2025-014",
    "status": "in orbit"
  },
  "sources_available": ["unoosa"]
}
```

### Add CelesTrak TLE

```bash
python3 import_celestrak_tle_sample.py --test-only
```

Query result (same endpoint):
```json
{
  "identifier": "2025-206B",
  "canonical": {
    "name": "(GLONASS)",  // UNOOSA (unchanged)
    "country_of_origin": "Russian Federation",  // UNOOSA (unchanged)
    "registration_number": "3832-2025-014",  // UNOOSA (unchanged)
    "status": "in orbit",  // UNOOSA (unchanged)
    "orbit": {
      "apogee_km": 406.15,
      "perigee_km": 402.53,
      "inclination_degrees": 51.64,
      "period_minutes": 92.65
    },
    "tle": {
      "line1": "1 25544U 98067A ...",
      "line2": "2 25544  51.6432 ..."
    }
  },
  "sources_available": ["unoosa", "celestrak"]
}
```

**Same endpoint, richer data!** No frontend changes needed.

## Scheduled Updates

Keep data fresh with periodic imports:

```bash
# Daily at 2 AM
0 2 * * * cd /kessler && python3 import_celestrak_tle_sample.py
```

Each run:
1. Fetches latest TLE from CelesTrak
2. Updates matching documents
3. Recalculates canonical sections
4. Updates timestamps

## Future Extensions

### Add Space-Track Data

Create `import_spacetrack.py`:
- Uses Space-Track API (requires account)
- Fetches TLE + satellite objects
- Updates with `source="spacetrack"`
- Canonical automatically merges

### Add Debris Data

Create `import_debris_data.py`:
- Satellite Situation Report
- DEBRIS data
- Updates with `source="debris"`
- Canonical includes debris status

### Add Ground Station Data

Create `import_ground_stations.py`:
- Tracking station locations
- Contact windows
- Pass predictions
- Updates with `source="groundstations"`

All automatically merge into canonical!

## Getting Started

1. **Setup MongoDB**:
   ```bash
   mongosh localhost:27017
   ```

2. **Import UNOOSA**:
   ```bash
   pip install pymongo
   python3 import_to_mongodb.py --clear
   ```

3. **Add CelesTrak TLE**:
   ```bash
   python3 import_celestrak_tle_sample.py --test-only
   ```

4. **Test API**:
   ```bash
   python -m uvicorn api:app --port 8000
   curl http://localhost:8000/v2/satellite/2025-206B
   ```

5. **Schedule Updates**:
   ```bash
   crontab -e
   # Add: 0 2 * * * cd /kessler && python3 import_celestrak_tle_sample.py
   ```

## Documentation

- **MONGODB_SETUP.md** - Complete MongoDB setup guide
- **QUICKSTART_MONGODB.md** - 5-minute quick start
- **MONGODB_INTEGRATION_SUMMARY.md** - Architecture & design
- **CELESTRAK_IMPORT.md** - CelesTrak TLE import details
- **This document** - Multi-source architecture

## Key Files

| File | Purpose |
|------|---------|
| `db.py` | MongoDB database layer |
| `import_to_mongodb.py` | UNOOSA CSV import |
| `import_celestrak_tle.py` | CelesTrak TLE import (network) |
| `import_celestrak_tle_sample.py` | CelesTrak TLE import (with fallback) |
| `api.py` | FastAPI with v2 endpoints |

## Summary

The **envelope pattern** with **source priority** creates a robust, flexible system for managing satellite data from multiple sources:

‚úÖ **Flexible**: Add sources without breaking changes
‚úÖ **Lossless**: All source data preserved
‚úÖ **Automatic**: Canonical updates on every import
‚úÖ **Transparent**: See where each piece of data comes from
‚úÖ **Scalable**: Works with 5,000+ satellites
‚úÖ **Future-proof**: Easy to add new sources

Start with UNOOSA. Add CelesTrak. Later add Space-Track. Each step automatically improves data quality without touching existing code.
